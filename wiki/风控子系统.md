### 概述
&emsp;&emsp;为了最大程度的降低风控相关模块对交易通道的性能影响，交易通道中的交易服务仅用于处理事前风控，所有的事中风控都独立出来，交由风控子系统处理，比较典型的是盈亏的计算，风控子系统实时维护一份仓位信息，同时也订阅了持仓标的的最新价信息，有了这些信息，风控子系统就可以实时计算已实现和未实现的盈亏信息且不影响报单通道的性能。  
&emsp;&emsp;风控子系统会根据每一条仓位信息对应的品种的实时价格计算并更新未实现盈亏，同时记录这个未实现盈亏的更新时间，这样仓位信息订阅方就可以知道未实现盈亏是根据什么时间点的行情计算得出，防止由于行情延迟而根据过早的实时价格计算得到的未实现盈亏而做出错误的判断。  
</br>  

### 仓位信息  
&emsp;&emsp;风控子系统会发布多个维度的仓位信息，其他子系统都可以通过订阅相关的topic以获取需要的信息。目前会定时发布包含以下字段的各个维度全量的仓位信息。另外仓位一旦发生变化时也会实时发送最新的全量仓位信息。考虑的有些市场支持单边持仓功能，没有什么字段可以体现多空，因此仓位等字段设计为正数表示多头头寸，负数表示空头头寸。  

| 维度字段 | 维度名称 | 维度说明 |
| ---- | ---- | ---- |
| productGrpId | 产品组合 |  |
| productId | 产品 |  |
| userId | 用户 |  |
| acctGrpId | 账号组合 | |
| acctId | 账号 | |
| trdAcctId | 交易账号 | |
| stgGrpId | 策略组合 |  |
| stgId | 策略 | |
| stgInstId | 策略实例 | |
| algoId | 算法单 | |
| marketCode | 市场 | |
| symbolType | 代码类型 | |
| symbolCode | 代码 | |
| side | 买卖 | |
| posSide | 多空 | |
| parValue | 面值/合约乘数 | |
| feeCurrency | 手续费币种 | 为接入更多的市场预留 |
| fee | 手续费 |  |
| pos | 仓位 |  |
| prePos | 前一结算周期仓位，国内体现为昨仓 |  |
| avgOpenPrice | 开仓均价 |  |
| preAvgOpenPrice | 前一结算周期开仓均价 |  |
| pnlUnReal | 未实现盈亏 |  |
| pnlReal | 已实现盈亏 |  |
| totalBidSize | 当前仓位累计买入数量 |  |
| totalAskSize | 当前仓位累计卖出数量 |  |
| preTotalBidSize | 前一结算周期当前仓位累计买入数量 |  |
| preTotalAskSize | 前一结算周期当前仓位累计卖出数量 |  |
| totalOpenSize | 累计开仓数 | 流控中totalOpenSize减去preTotalOpenSize得到开今仓的数量 |
| preTotalOpenSize | 前一结算周期累计开仓数 |  |
  
</br>  
</br>  
</br>  

### 发布的主题    
&emsp;&emsp;目前风控子系统会定时发布的topic    

* 所有仓位  
```shell
  // 所有的仓位信息
  shm://RISK/PubChannel/Trade/PosInfo/All
```


</br>  
</br>  

* 策略层面的仓位  
```shell
  // 策略编号10000的仓位信息
  shm://RISK/PubChannel/Trade/PosInfo/StgId/10000  
```

</br>  
</br>  

* 策略实例层面的仓位  
```shell
  // 订阅策略编号10000下策略实例编号为1的仓位信息
  shm://RISK/PubChannel/Trade/PosInfo/StgId/10000/StgInstId/1  
```
</br>  
</br>  

* 账户层面的仓位  
```shell
  // 订阅账户编号10001的仓位信息
  shm://RISK/PubChannel/Trade/PosInfo/AcctId/10001  
```
</br>  
</br>  

### 其他    
&emsp;&emsp;风控子系统内部维护着一个所有已订阅品种的ticker列表用于计算未实现盈亏，同时有一个定时器会定时订阅仓位中每一个标的的ticker，这样即使仓位中出现了新的品种，也能订阅并获取它的ticker    
