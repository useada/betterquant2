### 概述
&emsp;&emsp;行情网关主要负责连接外部行情服务，每个行情网关连接各种不同的行情源，订阅并接收行情，同时将其转换为系统内部统一的格式，最后推送给订阅方，订阅方可以是交易策略、风控子系统、交易服务或者其他任何想要订阅各种行情的子系统。  
&emsp;&emsp;行情网关除了推送行情给订阅方之外，还可以根据配置将各种不同类型的行情如订单簿、逐笔成交或者逐笔委托保存到时序数据库，供策略或者其他子系统提取历史行情使用。另外通过行情网关的配置，你可以选择是否订阅全市场行情，是否将指定[行情类型](行情网关#行情类型)的数据保存到时序数据库，是否保存代码表到数据库，是否通过Tickers创建LastPrice和Bid1Ask1类型的行情数据等等。如果你没有选择全市场订阅行情，那么系统会通过订阅管理器获取订阅方指定的topic发起订阅或者取消订阅。   
&emsp;&emsp;行情网关会为每一个交易市场创建一个基于共享内存的IPC服务，通过这个IPC服务订阅行情的topic格式如下：shm://MD.市场.期现类型/代码/[行情类型](行情网关#行情类型)，比如shm://MD.SSE.Spot/600600/Trades，期现类型可以是Spot或者Futures。  
&emsp;&emsp;如果将行情网关配置中的simedMode下的enable置为true，那么行情网关将不再从行情源获取行情，而是从时序数据库提取历史行情并推送，通过这种方式，策略端可以使用历史行情进行回测。  

### 行情类型  
&emsp;&emsp;目前行情服务提供的行情类型包括以下几种：  
* Trades  
逐笔成交，也就是市场上每一笔成交信息。  

* Orders  
逐笔委托，也就是市场上每一比委托信息，有些柜台的完整盘口就是根据Orders数据生成。  

* Books  
一些api会提供订单簿信息，通常是由Orders信息合成而来，市场上买卖盘信息。  

* Tickers  
来自国内期货交易所的行情快照切片，其中的盘口数据level1是1档，level2是5档，切片频率除了大商所和郑商所的level2都是1秒2次，大商所和郑商所的level2是1秒4次。来自国内现货交易所的行情快照切片，其中的盘口数据level1是5档，level2是10档，不管是level1还是level2，切片的频率都是3秒1次。除了盘口数据之外，行情切片通常还包含当日最高价、最低价、当日累计成交数量和金额、涨跌停价等等。  

* Bid1Ask1  
最优买卖价格信息，很多时候行情的订阅方，比如交易策略，并不需要tickers或者Books中大量的行情信息，而只需要最优的买卖盘口信息也就是买一和卖一的价和量，这时候就可以订阅Bid1Ask1类型的行情数据。  

* LastPrice  
最新价，和Bid1Ask1类似，很多情况时候订阅方也只关心最新价，如果没有LastPrice，我们要获取最新价，在国内的现货市场一般通过Trades也就是逐笔成交获取最新价，而在国内的期货市场则是通过Tickers获取，这样在实现一些业务逻辑的时候比如说计算未实现盈亏等等，就要针对市场做区分对待，非常的麻烦，因此系统提供了最新价的订阅接口。  

* DynCandle  
最后说明下，系统还提供了动态Candle的功能，和常规的Candle不同，动态Candle可以让你指定生成Candle的起始时间和周期，通过动态Candle你可以获取你指定的起始时间和任意周期内的高开低收，和传统的Candle相比，动态Candle更为灵活，因为订阅方的订阅动态Candle的起始时间和周期都不尽相同，所以动态Candle不是在行情网关服务中而是在策略引擎中动态生成的。  

&emsp;&emsp;最后说明下，行情网关服务并不提供所有上述类型的行情，比如期货行情接口基本都不提供逐笔成交和逐笔委托。   

### 行情回放  
&emsp;&emsp;行情网关除了提供实盘行情之外，还允许我们提取时序数据库中的历史行情进行回放，另外还允许你通过配置指定回放那些代码、回放的速度、回放的历史行情的起始时间和结束时间，为了确保回放的速度和稳定性，系统启动时会从时序数据库中提取并预加载若干个行情缓存，回放模块会从行情缓存中提取行情并回放。行情缓存的数量及其他信息都可以在配置中指定。

<img src="https://github.com/byrnexu/bq/assets/24740973/c7b24bb5-a624-4b73-ad72-597393ae5bf5" width="800">

以上为回放相关配置。

### 接入新的行情服务  
&emsp;&emsp;系统已经将接入行情的各种通用部分的代码抽象分离出来放在行情网关基础类库中，通过行情网关基础类库，你可以方便的接入各种各样的行情源。