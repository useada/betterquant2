### 概述
&emsp;&emsp;当策略引擎发起一笔报单的时候，该订单会被先发往交易服务，交易服务再将该订单发往当前订单的账号所对应的交易网关，最后交易网关将这笔订单法发到交易柜台。
</br>  
&emsp;&emsp;交易服务的主要功能是，订单的预处理也就是净头寸管理，另外还负责风控模组的管理和维护，而风控模组之前也简单提过是负责事前风控的，换句话也可以这么说，交易服务主要就是负责事前风控的。由于我们整个架构中还有一个风控子系统的存在，从模块的拆分来讲难道事前风控不应该放在风控子系统中么？首先答案肯定是事前风控必须放在交易服务中。这个原因得从事前、事中和事后风控的定义来解释。    
</br>  
&emsp;&emsp;**我们先来看看chatGPT对事前、事中和事后风控的解释：**  
* 事前风控（Pre-trade Risk Control）：
事前风控是在交易发生之前进行的风险管理。其目的是对交易参与方进行合规性、资金、仓位和风险的检查和限制，以防止非法、不当或过度风险的交易发生。事前风控通常包括但不限于身份验证、资金限额、持仓限额、交易合规性检查等。
* 事中风控（In-trade Risk Control）：
事中风控是在交易进行过程中进行的实时风险监控和控制。其目的是对交易活动和市场波动进行监测，及时发现异常情况并采取相应措施。事中风控通常包括但不限于市场价格监测、交易量监测、系统流量监测、交易异常检测等。
* 事后风控（Post-trade Risk Control）：
事后风控是在交易完成后进行的风险评估和处理。其目的是对交易结果进行回顾和分析，评估交易的风险和效果，并采取相应的风险管理措施。事后风控通常包括但不限于交易数据分析、异常交易监测、追溯交易信息、风险报告生成等。

&emsp;&emsp;这三个阶段的风控措施相互补充，旨在保护市场的稳定运行和交易参与方的利益。通过事前风控可以筛选出不符合要求或高风险的交易，事中风控可以及时监测和处理异常情况，事后风控可以评估和总结交易风险并采取相应的改进措施。这些风控措施的实施有助于维护交易市场的健康发展和参与者的信心。
</br>  

&emsp;&emsp;**实际上关于事前和事中风控还有另一种解释：**
* 事前风控（Pre-trade Risk Control）：
事前风控是指那些在数值上绝对不允许出错的风控措施。它们旨在在交易执行之前严格验证和限制各种风险因素，以确保交易的合规性和安全性。在事前风控中，任何超过预先设定的限制或条件的交易都将被拒绝或暂停执行。这些限制可能涉及交易的金额、仓位、报单次数和频率等。事前风控是为了防止重大风险和错误发生，确保交易在事前通过了一系列严格的审核和验证。

* 事中风控（In-trade Risk Control）：
事中风控是允许有一定程度误差存在的风控措施。它们旨在在交易执行过程中实时监测和控制风险，并及时采取措施来纠正异常情况。与事前风控不同，事中风控容许一定程度的误差或风险，但仍然在可接受的范围内。事中风控可能包括价格偏移限制、盈亏控制等。这些措施旨在及时识别和应对风险，以避免进一步的损失或系统崩溃。

&emsp;&emsp;**实际上这两种解释本质是一样的：**  
</br>  
&emsp;&emsp;因为事前风控在数值上绝对不允许出错，所以事前风控只能在交易通道上进行，系统中订单经由策略引擎发起，到达交易服务，最后通过交易网关报到交易柜台，因此事前风控只能在上述几个步骤的某个环节进行，也就是交易发生之前进行，而事中风控可以有稍许误差，因此对于那些理论上无法精准确定数值的一些数据的风控，可以在事中风控中处理，为了尽可能的不影响报单效率，BetterQuant专门开发了风控子系统用于事中风控的处理。
</br>  
</br>  

### 净头寸管理    
&emsp;&emsp;有时候一个资金账号可能会被多个交易策略使用，对于同一个交易品种，有的策略会做多，有的策略会做空，因为有的交易所并不支持单向大边保证金或者单边持仓功能，所以为了尽可能的降低保证金占用，BetterQuant提供了净头寸管理功能，当一个报单请求通过策略引擎到达交易服务的时候，如果该订单只是指定了买和卖，没有指定开和平，那么交易服务会先检查订单中指定的资金账号下有没有反向的头寸，如果有的话，那么再确定开和平，这样对于资金账号层面来说就大大降低的保证金占用。  
&emsp;&emsp;系统同时还允许多个账号绑定在一起，成为一个账号组合共享仓位，实现了跨账户净头寸管理功能。  
</br>  

### 风控模组  
&emsp;&emsp;前面提到了，事前风控只能在交易通道上进行，但是交易通道会经过一系列环节，比如策略引擎、交易服务、交易网关，因为策略引擎往往只有策略层面的资金和仓位、交易网关只有账号层面的仓位和数据，而交易服务有所有账号和策略的仓位和数据，因此在交易服务做事前风控是最合适的。  
&emsp;&emsp;BetterQuant中订单在经过交易服务的预处理也就是净头寸管理模块之后，会进入了事前风控环节，而事前风控可能会有很多不同的维度，比如全局层面、产品层面、账号层面、策略层面等等，假如有一个全局层面的风控，就需要一个全局锁，这就会导致其他细粒度的风控都会把限制在这个全局锁里，严重影响报单效率，因此系统被设计为可以通过配置让你创建各种维度的风控模组，每个风控模组就像一个容器，你可以放入你想要的风控插件，这就使得整个事前风控的环节可以灵活定制而又不失效率。    
</br>  

如图所示，下面有三个风控模组，每个风控模组下放入了若干个插件和该插件的配置：  

![image](https://github.com/byrnexu/bq/assets/24740973/c383ea71-d81d-4d2d-ae50-f20dfa12e5c1)  

